# _chanting_ rust, Rust, RUst, RUSt, RUST
language: rust

stages:
- test
# Deploy stage on runs on a valid semver tag, regardless of branch
- name: deploy
  if: tag =~ /^\d+\.\d+\.\d+.*$/

env:
  global:
  # We always want full stack traces in the event of a panic
  - RUST_BACKTRACE=1

# See http://www.garbers.co.za/2017/11/01/code-folding-and-timing-in-travis-ci/
# this just allows us to give _somewhat_ better views of the build steps
before_script:
- export -f travis_nanoseconds
- export -f travis_fold
- export -f travis_time_start
- export -f travis_time_finish

matrix:
  # We allow failures for the 'nightly' channel, but are ok with failures on 'beta'
  allow_failures:
  - env: NIGHTLY=1
  fast_finish: true

  include:
  #  _      _       _   
  # | |    (_)     | |  
  # | |     _ _ __ | |_ 
  # | |    | | '_ \| __|
  # | |____| | | | | |_ 
  # |______|_|_| |_|\__|

  # 1. Ensure rustfmt does not produce diffs. We always use
  # the default rustfmt settings.
  # 2. Ensure there are no clippy warnings.
  - name: "stable lint"
    # We could use a lint stage here, but prefer to go wide
    #
    stage: test
    rust: stable
    os: linux
    script: .ci/lint.sh

  #  _______        _   
  # |__   __|      | |  
  #    | | ___  ___| |_ 
  #    | |/ _ \/ __| __|
  #    | |  __/\__ \ |_ 
  #    |_|\___||___/\__|

  # Tests all platforms on stable
  # and additionally running beta and nightly
  # tests on Linux as Linux runs are generally
  # faster in every aspect on Travis

  - name: "stable test linux"
    stage: test
    rust: stable
    os: linux
    script: .ci/test.sh

  - name: "stable test osx"
    rust: stable
    os: osx
    script: .ci/test.sh

  - name: "stable test windows"
    rust: stable
    os: windows
    script: .ci/test.sh

  # Add more testing stages if you have them!

  #  _____       _     _ _     _     
  # |  __ \     | |   | (_)   | |    
  # | |__) |   _| |__ | |_ ___| |__  
  # |  ___/ | | | '_ \| | / __| '_ \ 
  # | |   | |_| | |_) | | \__ \ | | |
  # |_|    \__,_|_.__/|_|_|___/_| |_|

  # Publish a release to crates.io. The only
  # thing you need to do is to is change the repo
  # below, and provide the output of the `travis encrypt <crates_io_token>`
  # in the deploy.token.secure value. Note that you will
  # need to encrypt the same key for different repos, you
  # can't just copy the value from another repo.
  - stage: deploy
    rust: stable
    os: linux
    script: echo "deploying $TRAVIS_TAG to crates.io"
    deploy:
      provider: cargo
      token:
        secure: kFHR6U9EHSCFNOcJDcTMLIA73MqE+CND5QrzVI42F6p2GrJezd+7pnxacER657Fy53ojhgZTobpxR3JspXZzcb7WRQhvHN1Z+/ocggSUXF8ChOFcevQ6YD8ezfw4tdJXFBc/2I6yEiPxuMjYpJ9KrEF9QBCt+n53a2K713JBQ2TNe/+RW4NRutlMlXgFOBI9nEnSPpyGjTgIf5hLFhzJuVoz53b/F00C1pTwCwIzfjosmocN+Rm7YHVrn8t+evdHC9NIYWedx3Ealb6VPtX9XVOEGXPv7HI1l9MHTlp5mSplSnTQfFercmGy+GAzVoxxfp3Yr2xJIBIfmJi2nLURI+g+4VIPwtLd4yH1scad6EbXpfHKxOSxlI60qfmvdaejmkY6YRE06meNfYWxHzQNTFSEifUIlJLK1xLmMfZKmFfHAWeyYRzwQHKpY6/GhVmTJsuL0j2yamQdvX68rgzV2oqfulwlHfCRTKGIWA2Yh7FQqJ5DifcSsEupKAbw98XbTXP1YhcFKsbSljLkonZ5osxtSR+XSfbOtD282pMO8JeD827dYjKEP3SSAVacamwsTl1ivJYBzAvDfXsT1NcTZDh0laPETKstQxSqO9DU2kOgBOuvoKxxWs4HmEp4fsjQeyZHeT9uqA/ZcH0x+iZ7t1dutPDih6Xh5TFxLArW50M=
      on:
        repo: EmbarkStudios/spdx
        tags: true
